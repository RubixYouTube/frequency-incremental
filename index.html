<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hertz Incremental - v0.4.4a</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/gh/Patashu/break_eternity.js@master/break_eternity.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{transition:background 0.5s ease,color 0.3s ease;font-family:'Segoe UI',sans-serif}
@keyframes bgShift{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
.animated-bg{background-size:400% 400%;animation:bgShift 15s ease infinite}
.tab{transition:all 0.3s ease;position:relative;overflow:hidden}
.tab::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.2),transparent);transition:left 0.5s ease}
.tab:hover::before{left:100%}
.tab:hover{transform:translateX(5px);box-shadow:0 0 20px rgba(255,255,255,0.3)}
.popup,.popup2,.popup-theme,.popup-infinity,.popup-eternity{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:450px;padding:25px;display:none;flex-direction:column;border-radius:15px;box-shadow:0 0 30px rgba(0,0,0,0.8);opacity:0;transition:opacity 0.3s ease;backdrop-filter:blur(15px);z-index:1000;border:2px solid rgba(255,255,255,0.3);background:rgba(0,0,0,0.92)}
.popup.visible,.popup2.visible,.popup-theme.visible,.popup-infinity.visible,.popup-eternity.visible{display:flex;opacity:1}
.popup{width:400px;padding:20px;text-align:center;font-size:1.1rem;font-weight:bold}
.popup-infinity,.popup-eternity{width:700px;min-height:350px;justify-content:center;align-items:center}
.popup-infinity{border-color:#8b5cf6}
.popup-eternity{border-color:#00e870}
.typing-text{font-size:1.2rem;line-height:1.8;color:#a78bfa;text-align:center;margin-bottom:30px;min-height:150px}
.typing-text-et{background:linear-gradient(90deg,#00e870,#00aede,#00ba54);background-size:200% 200%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:grad 3s ease infinite}
.achievement{background:linear-gradient(135deg,#064e3b,#065f46);border:2px solid #10b981;width:100%;padding:16px;display:flex;align-items:center;justify-content:space-between;border-radius:10px;margin-top:10px;transition:all 0.3s;box-shadow:0 4px 6px rgba(0,0,0,0.3);font-size:1rem;font-weight:bold}
.achievement.completed{background:linear-gradient(135deg,#10b981,#34d399);color:#000}
.upgrade-card{background:rgba(255,255,255,0.05);border:2px solid rgba(255,255,255,0.2);border-radius:15px;padding:16px;transition:all 0.3s;backdrop-filter:blur(10px)}
.upgrade-card:hover{transform:translateY(-3px);box-shadow:0 10px 30px rgba(0,0,0,0.5);border-color:rgba(255,255,255,0.5)}
.upgrade-btn{padding:10px 20px;border:2px solid;border-radius:10px;font-weight:bold;transition:all 0.3s;cursor:pointer;background:rgba(255,255,255,0.1);text-transform:uppercase;letter-spacing:1px;font-size:0.85rem}
.upgrade-btn:hover:not(:disabled){transform:scale(1.05);box-shadow:0 0 20px currentColor}
.upgrade-btn:disabled{opacity:0.4;cursor:not-allowed}
.theme-btn{width:55px;height:55px;border-radius:50%;border:3px solid #fff;margin:8px;cursor:pointer;transition:all 0.3s;position:relative}
.theme-btn:hover{transform:scale(1.2);box-shadow:0 0 20px currentColor}
.theme-btn.active::after{content:'✓';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:26px;color:#fff;text-shadow:0 0 10px #000}
.stat-display{background:linear-gradient(135deg,rgba(255,255,255,0.1),rgba(255,255,255,0.05));border-radius:15px;padding:25px;margin:15px 0;border:2px solid rgba(255,255,255,0.2);box-shadow:0 8px 16px rgba(0,0,0,0.3)}
.prestige-btn{border:3px solid;padding:16px 32px;border-radius:15px;font-size:1.3rem;font-weight:bold;color:#fff;cursor:pointer;transition:all 0.3s;text-transform:uppercase;letter-spacing:2px}
.prestige-btn:hover:not(:disabled){transform:translateY(-3px)}
.prestige-btn:disabled{opacity:0.4;cursor:not-allowed;background:#4b5563!important}
.version{position:fixed;bottom:10px;left:10px;color:rgba(255,255,255,0.5);text-shadow:0 0 5px rgba(255,255,255,0.5);font-size:0.85rem}
.hidden{display:none!important}
.grid-upgrades{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:15px;margin-top:15px}
.machine-card{background:linear-gradient(135deg,rgba(255,255,255,0.1),rgba(255,255,255,0.05));border:3px solid;border-radius:15px;padding:15px;text-align:center;transition:all 0.3s}
.machine-card:hover{transform:scale(1.03);box-shadow:0 0 25px currentColor}
.machine-card.locked{opacity:0.4;filter:grayscale(100%)}
.nerf-indicator{background:rgba(255,0,0,0.2);border:2px solid #ff0000;padding:10px;border-radius:10px;margin-top:10px;font-weight:bold}
@keyframes grad{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
.infinity-text{background:linear-gradient(90deg,#8b5cf6,#ec4899,#8b5cf6);background-size:200% 200%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:grad 3s ease infinite}
.eternity-text{background:linear-gradient(90deg,#00e870,#00aede,#00ba54,#00e870);background-size:200% 200%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:grad 3s ease infinite}
.rainbow-text{background:linear-gradient(90deg,red,orange,yellow,green,blue,purple,pink);background-size:200% 200%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:grad 3s ease infinite}
.scrollable-content{max-height:calc(100vh - 40px);overflow-y:auto;padding-right:10px}
.scrollable-content::-webkit-scrollbar{width:8px}
.scrollable-content::-webkit-scrollbar-track{background:rgba(255,255,255,0.05);border-radius:10px}
.scrollable-content::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.2);border-radius:10px}
.sidebar-tabs{max-height:calc(100vh - 40px);overflow-y:auto}
.sidebar-tabs::-webkit-scrollbar{width:6px}
.sidebar-tabs::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.2);border-radius:10px}
/* Themes */
.theme-red{background:linear-gradient(135deg,#7f1d1d,#991b1b,#b91c1c,#7f1d1d);color:#fca5a5}
.theme-red .text-primary{color:#ef4444!important}.theme-red .text-secondary{color:#fca5a5!important}
.theme-orange{background:linear-gradient(135deg,#7c2d12,#9a3412,#c2410c,#7c2d12);color:#fdba74}
.theme-orange .text-primary{color:#f97316!important}.theme-orange .text-secondary{color:#fdba74!important}
.theme-yellow{background:linear-gradient(135deg,#713f12,#854d0e,#a16207,#713f12);color:#fde047}
.theme-yellow .text-primary{color:#eab308!important}.theme-yellow .text-secondary{color:#fde047!important}
.theme-green{background:linear-gradient(135deg,#14532d,#166534,#15803d,#14532d);color:#86efac}
.theme-green .text-primary{color:#22c55e!important}.theme-green .text-secondary{color:#86efac!important}
.theme-blue{background:linear-gradient(135deg,#1e3a8a,#1e40af,#2563eb,#1e3a8a);color:#93c5fd}
.theme-blue .text-primary{color:#3b82f6!important}.theme-blue .text-secondary{color:#93c5fd!important}
.theme-purple{background:linear-gradient(135deg,#581c87,#6b21a8,#7c3aed,#581c87);color:#d8b4fe}
.theme-purple .text-primary{color:#a855f7!important}.theme-purple .text-secondary{color:#d8b4fe!important}
.theme-pink{background:linear-gradient(135deg,#831843,#9f1239,#be123c,#831843);color:#fbcfe8}
.theme-pink .text-primary{color:#ec4899!important}.theme-pink .text-secondary{color:#fbcfe8!important}
.theme-brown{background:linear-gradient(135deg,#3e2723,#4e342e,#5d4037,#3e2723);color:#d7ccc8}
.theme-brown .text-primary{color:#a1887f!important}.theme-brown .text-secondary{color:#d7ccc8!important}
.theme-black{background:linear-gradient(135deg,#000,#111,#1a1a2e,#000);color:#e5e5e5}
.theme-black .text-primary{color:#fff!important}.theme-black .text-secondary{color:#d1d5db!important}
.theme-white{background:linear-gradient(135deg,#e5e5e5,#f5f5f5,#fafafa,#e5e5e5);color:#1a1a1a}
.theme-white .text-primary{color:#000!important}.theme-white .text-secondary{color:#374151!important}
.theme-white .stat-display,.theme-white .upgrade-card{background:rgba(0,0,0,0.05);border-color:rgba(0,0,0,0.2)}
/* Code editor */
.code-editor{width:100%;min-height:300px;background:#0d1117;color:#c9d1d9;border:2px solid #30363d;border-radius:12px;padding:15px;font-family:'Fira Code','Courier New',monospace;font-size:14px;line-height:1.6;resize:vertical;outline:none;tab-size:2}
.code-editor:focus{border-color:#58a6ff}
.console-output{width:100%;height:200px;background:#0d1117;color:#8b949e;border:2px solid #30363d;border-radius:12px;padding:15px;font-family:'Fira Code','Courier New',monospace;font-size:13px;line-height:1.5;overflow-y:auto;white-space:pre-wrap}
.console-output .log-info{color:#58a6ff}
.console-output .log-success{color:#3fb950}
.console-output .log-error{color:#f85149}
.console-output .log-warn{color:#d29922}
.doc-section{background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.15);border-radius:10px;padding:15px;margin:10px 0}
.doc-section code{background:rgba(255,255,255,0.1);padding:2px 6px;border-radius:4px;font-family:'Fira Code','Courier New',monospace;font-size:0.9em}
</style>
</head>
<body class="theme-black animated-bg font-sans h-screen overflow-hidden">
<div class="flex h-full">
<!-- Sidebar -->
<div class="w-1/5 bg-black bg-opacity-50 p-4 border-r-2 border-white border-opacity-20">
<div class="sidebar-tabs flex flex-col space-y-2" id="sidebar-tabs"></div>
</div>
<!-- Main Content -->
<div class="flex-1 p-6 scrollable-content" id="main-content"></div>
</div>
<!-- Popups -->
<div id="popup" class="popup"></div>
<div id="popup2" class="popup2">
<div class="text-white text-xl font-bold mb-4"><i class="fas fa-upload"></i> Load Save</div>
<input id="save-input" type="text" placeholder="Paste your save here..." class="mt-2 p-3 rounded-lg bg-gray-700 text-white w-full border-2 border-gray-500 outline-none">
<div class="flex space-x-4 mt-5">
<button onclick="loadGameFromInput()" class="upgrade-btn border-green-400 text-green-400 flex-1">SUBMIT</button>
<button onclick="document.getElementById('popup2').classList.remove('visible')" class="upgrade-btn border-red-400 text-red-400 flex-1">CANCEL</button>
</div>
</div>
<div id="popup-theme" class="popup-theme">
<div class="text-white text-xl font-bold mb-4 text-center"><i class="fas fa-palette"></i> Theme</div>
<div class="flex flex-wrap justify-center" id="theme-buttons"></div>
<button onclick="document.getElementById('popup-theme').classList.remove('visible')" class="upgrade-btn border-gray-400 text-gray-400 mt-4 w-full">CLOSE</button>
</div>
<div id="popup-infinity" class="popup-infinity">
<div id="typing-text" class="typing-text"></div>
<button id="infinity-ok-btn" class="prestige-btn bg-gradient-to-r from-pink-500 to-purple-600 border-purple-400 hidden" onclick="acceptInfinity()">OK</button>
</div>
<div id="popup-eternity" class="popup-eternity">
<div id="typing-text-et" class="typing-text typing-text-et"></div>
<button id="eternity-ok-btn" class="prestige-btn bg-gradient-to-r from-green-500 to-cyan-500 border-green-400 hidden" onclick="acceptEternity()">OK</button>
</div>
<div class="version"><i class="fas fa-code"></i> v0.4.4a - The Automator Update</div>

<script>
// ===== BREAK ETERNITY USAGE =====
const D = (x) => new Decimal(x);
const ZERO = D(0);
const ONE = D(1);
const TEN = D(10);

// ===== UPGRADE DEFINITIONS =====
const UPGRADES = {
  hz: [
    {id:1,name:'Double Production',desc:'×2 Hz/s (softcap@100)',base:7,mult:2,icon:'arrow-up',color:'yellow'},
    {id:2,name:'Power Boost',desc:'×1.25 Hz/s (softcap@80)',base:100,mult:2.5,icon:'fire',color:'orange'},
    {id:3,name:'Frequency Surge',desc:'×1.5 Hz/s (softcap@60)',base:500,mult:3,icon:'rocket',color:'red'},
    {id:4,name:'Harmonic Resonance',desc:'×2 Hz/s (softcap@50)',base:2500,mult:4,icon:'star',color:'green'},
    {id:5,name:'Wave Amplifier',desc:'×3 Hz/s (softcap@40)',base:1e4,mult:5,icon:'chart-line',color:'blue'},
    {id:6,name:'Sonic Overdrive',desc:'×5 Hz/s (softcap@30)',base:5e4,mult:6,icon:'crown',color:'purple'}
  ],
  volume: [
    {id:1,name:'Volume Power',desc:'Volume effect ×1.5',base:10,mult:5,icon:'plus-circle',color:'purple'},
    {id:2,name:'Volume Multiplier',desc:'Volume gain ×2',base:25,mult:10,icon:'gem',color:'purple'},
    {id:3,name:'Resonant Freq',desc:'Hz/s ×2 direct',base:50,mult:20,icon:'bolt',color:'purple'},
    {id:4,name:'Compression',desc:'Hz upgrade efficiency',base:100,mult:50,icon:'compress-arrows-alt',color:'purple'},
    {id:5,name:'Log Scale',desc:'Hz boost from Hz (log)',base:250,mult:100,icon:'infinity',color:'purple'},
    {id:6,name:'Perfect Pitch',desc:'Advanced resonance',base:500,mult:250,icon:'magic',color:'purple'}
  ],
  speaker: [
    {id:1,name:'Speaker Amp',desc:'Speaker boost ×2',base:5,mult:10,icon:'volume-up',color:'teal'},
    {id:2,name:'Volume Enhance',desc:'Volume gain ×1.5',base:10,mult:25,icon:'layer-group',color:'teal'},
    {id:3,name:'Triple Hz',desc:'Hz/s ×3',base:20,mult:50,icon:'tachometer-alt',color:'teal'},
    {id:4,name:'Feedback Loop',desc:'Vol gain scales w/ Speakers',base:50,mult:100,icon:'sync-alt',color:'teal'},
    {id:5,name:'Vol Synergy',desc:'Hz boost from Volume',base:100,mult:200,icon:'atom',color:'teal'},
    {id:6,name:'Efficient Prestige',desc:'Speaker gain ×2',base:250,mult:500,icon:'recycle',color:'teal'},
    {id:7,name:'Megaphone',desc:'Hz/s ×10',base:1000,mult:1000,icon:'star',color:'teal'}
  ],
  infinity: [
    {id:1,name:"Nal's Blessing",desc:'Hz/s ×10',base:1,mult:5,icon:'rocket',color:'pink'},
    {id:2,name:'Vol Acceleration',desc:'Vol gain ×5',base:2,mult:10,icon:'volume-up',color:'pink'},
    {id:3,name:'Self-Synergy',desc:'Hz boost from Infinity',base:3,mult:15,icon:'infinity',color:'pink'},
    {id:4,name:'Speaker Boost',desc:'Speaker gain ×10',base:4,mult:20,icon:'broadcast-tower',color:'pink'},
    {id:5,name:'Cross-Layer',desc:'Hz from Speakers (log)',base:5,mult:25,icon:'layer-group',color:'pink'},
    {id:6,name:'Vol Compress',desc:'Vol gain from Infinity',base:6,mult:30,icon:'compress',color:'pink'},
    {id:7,name:'Hz Scaling',desc:'Hz from Hz (log^0.5)',base:7,mult:35,icon:'chart-line',color:'pink'},
    {id:8,name:'Speaker Synergy',desc:'Speaker gain from Inf',base:8,mult:40,icon:'users',color:'pink'},
    {id:9,name:'Reality Warp',desc:'Hz/s ×100',base:9,mult:45,icon:'fire',color:'pink'},
    {id:10,name:'Vol Meteor',desc:'Vol gain ×50',base:10,mult:50,icon:'meteor',color:'pink'},
    {id:11,name:'Perfect Harmony',desc:'Hz from Vol×Spk',base:11,mult:55,icon:'atom',color:'pink'},
    {id:12,name:'Speaker Storm',desc:'Speaker gain ×25',base:12,mult:60,icon:'asterisk',color:'pink'},
    {id:13,name:"Nal's Gift",desc:'Hz/s ×1000',base:13,mult:65,icon:'crown',color:'pink'},
    {id:14,name:'Eternal Loop',desc:'Infinity gain ×2',base:14,mult:70,icon:'redo',color:'pink'},
    {id:15,name:'Passive Infinity',desc:'0.01 Inf/s per level',base:15,mult:75,icon:'clock',color:'pink'}
  ],
  eternity: [
    {id:1,name:'Eternity Begins',desc:'ALL gains ×10',base:1,mult:10,icon:'seedling',color:'green'},
    {id:2,name:'Infinite Power',desc:'Inf gain ×100',base:2,mult:25,icon:'bolt',color:'green'},
    {id:3,name:'Eternal Boost',desc:'Hz/s ×(Et+1)^5',base:3,mult:50,icon:'rocket',color:'green'},
    {id:4,name:'Time Dilation',desc:'All prestige ×1000',base:5,mult:100,icon:'hourglass-half',color:'green'},
    {id:5,name:'Recursive Eternity',desc:'Eternity self-boost',base:10,mult:250,icon:'sync-alt',color:'green'},
    {id:6,name:'Machine Overload',desc:'Machines ×10000',base:15,mult:500,icon:'cogs',color:'green'},
    {id:7,name:'Ultimate Synergy',desc:'All layers multiply',base:25,mult:1000,icon:'star',color:'green'},
    {id:8,name:'Godly Presence',desc:'Hz/s ×1e10',base:50,mult:2500,icon:'crown',color:'green'},
    {id:9,name:'Infinity²',desc:'Inf effects ×Inf^0.5',base:100,mult:5000,icon:'square-root-alt',color:'green'},
    {id:10,name:'Eternal Machines',desc:'Machines boost Et gain',base:250,mult:1e4,icon:'industry',color:'green'},
    {id:11,name:'Time Compress',desc:'Upgrades 50% cheaper',base:500,mult:2.5e4,icon:'compress',color:'green'},
    {id:12,name:'Hyper Infinity',desc:'Passive Inf ×1000',base:1000,mult:5e4,icon:'infinity',color:'green'},
    {id:13,name:'Reality Break',desc:'Hz/s ×1e50',base:2500,mult:1e5,icon:'bomb',color:'green'},
    {id:14,name:'Omnipotence',desc:'All effects ×1e100',base:5000,mult:2.5e5,icon:'fist-raised',color:'green'},
    {id:15,name:'Eternal Recursion',desc:'Et ×log(Et+10)',base:1e4,mult:5e5,icon:'redo-alt',color:'green'},
    {id:16,name:'Transcendence',desc:'Bypass softcaps 50%',base:2.5e4,mult:1e6,icon:'arrow-up',color:'green'},
    {id:17,name:'Dim Shift',desc:'All gains ×1e200',base:5e4,mult:2.5e6,icon:'cube',color:'green'},
    {id:18,name:'Absolute Power',desc:'Et gain ×(Et+1)',base:1e5,mult:5e6,icon:'fire-alt',color:'green'},
    {id:19,name:'Omniscience',desc:'All resources ×1e500',base:2.5e5,mult:1e7,icon:'eye',color:'green'},
    {id:20,name:'End of Time',desc:'Passive Et 0.001/s/lvl',base:1e6,mult:1e8,icon:'skull-crossbones',color:'green'}
  ]
};

const ACHIEVEMENTS = [
  {id:'ach1',name:'First Hertz',desc:'Reach 1 Hz',check:()=>G.hz.gte(1)},
  {id:'ach2',name:'Frequency Rising',desc:'Reach 100 Hz',check:()=>G.hz.gte(100)},
  {id:'ach3',name:'Sonic Boom',desc:'Reach 10,000 Hz',check:()=>G.hz.gte(1e4)},
  {id:'ach4',name:'Turn It Up!',desc:'Unlock Volume',check:()=>G.volumeUnlocked},
  {id:'ach5',name:'Sound System',desc:'Unlock Speakers',check:()=>G.speakersUnlocked},
  {id:'ach6',name:'Concert Hall',desc:'Reach 10 Speakers',check:()=>G.speakers.gte(10)},
  {id:'ach7',name:'Reality Breaker',desc:'Unlock Infinity',check:()=>G.infinityUnlocked},
  {id:'ach8',name:'Machine God',desc:'Reach 1M Infinity',check:()=>G.infinity.gte(1e6)},
  {id:'ach9',name:'Eternal',desc:'Unlock Eternity',check:()=>G.eternityUnlocked},
  {id:'ach10',name:'Million Hz',desc:'Reach 1e6 Hz',check:()=>G.hz.gte(1e6)},
  {id:'ach11',name:'Billion Hz',desc:'Reach 1e9 Hz',check:()=>G.hz.gte(1e9)},
  {id:'ach12',name:'Volume Lord',desc:'Reach 1000 Volume',check:()=>G.volume.gte(1000)},
  {id:'ach13',name:'Speaker Master',desc:'Reach 100 Speakers',check:()=>G.speakers.gte(100)},
  {id:'ach14',name:'Infinity×10',desc:'Infinitize 10 times',check:()=>G.infinityTimes.gte(10)},
  {id:'ach15',name:'Rainbow Power',desc:'Unlock Rainbow Machine',check:()=>G.infinity.gte(1e80)},
  {id:'ach16',name:'Automator',desc:'Unlock Automations',check:()=>G.automatorUnlocked},
  {id:'ach17',name:'Eternal×5',desc:'Eternitize 5 times',check:()=>G.eternityTimes.gte(5)},
  {id:'ach18',name:'1e100 Hz',desc:'Reach 1e100 Hz',check:()=>G.hz.gte("1e100")},
  {id:'ach19',name:'Monochrome Master',desc:'Unlock Monochrome Machine',check:()=>G.infinity.gte(1e100)},
  {id:'ach20',name:'Infinity Pool',desc:'Reach 1e50 Infinity',check:()=>G.infinity.gte("1e50")},
];

const TABS = [
  {id:'hz',name:'Hz',icon:'bolt',color:'bg-white',border:'border-white',size:'text-3xl'},
  {id:'volume',name:'Volume',icon:'volume-up',color:'bg-purple-500',border:'border-purple-500',hidden:()=>!G.volumeUnlocked},
  {id:'speakers',name:'Speakers',icon:'broadcast-tower',color:'bg-teal-500',border:'border-teal-500',hidden:()=>!G.speakersUnlocked},
  {id:'infinity',name:'Infinity',icon:'infinity',color:'bg-pink-500',border:'border-pink-500',hidden:()=>!G.infinityUnlocked},
  {id:'eternity',name:'Eternity',icon:'hourglass-half',color:'bg-green-500',border:'border-green-500',hidden:()=>!G.eternityUnlocked},
  {id:'machines',name:'Machines',icon:'cogs',color:'bg-purple-500',border:'border-purple-500',hidden:()=>!G.machinesUnlocked},
  {id:'automator',name:'Automator',icon:'code',color:'bg-blue-500',border:'border-blue-500',hidden:()=>!G.automatorUnlocked},
  {id:'achievements',name:'Achievements',icon:'trophy',color:'bg-green-500',border:'border-green-500'},
  {id:'settings',name:'Settings',icon:'cog',color:'bg-orange-500',border:'border-orange-500'},
  {id:'changelog',name:'Changelog',icon:'list',color:'bg-blue-500',border:'border-blue-500'},
  {id:'about',name:'About this?',icon:'question-circle',color:'bg-yellow-500',border:'border-yellow-500'},
];

const THEMES = ['red','orange','yellow','green','blue','purple','pink','brown','black','white'];
const THEME_COLORS = {red:'#991b1b,#dc2626',orange:'#9a3412,#ea580c',yellow:'#854d0e,#eab308',green:'#166534,#22c55e',blue:'#1e40af,#3b82f6',purple:'#6b21a8,#a855f7',pink:'#9f1239,#ec4899',brown:'#4e342e,#795548',black:'#000,#374151',white:'#e5e5e5,#fff'};

const MACHINES = [
  {id:'red',name:'Red',req:1e6,mult:2,color:'#ef4444'},
  {id:'orange',name:'Orange',req:1e9,mult:3,color:'#f97316'},
  {id:'yellow',name:'Yellow',req:1e12,mult:5,color:'#eab308'},
  {id:'green',name:'Green',req:1e15,mult:10,color:'#22c55e'},
  {id:'blue',name:'Blue',req:1e20,mult:25,color:'#3b82f6'},
  {id:'purple',name:'Purple',req:1e30,mult:100,color:'#a855f7'},
  {id:'pink',name:'Pink',req:1e40,mult:1000,color:'#ec4899'},
  {id:'brown',name:'Brown',req:1e60,mult:1e4,color:'#a1887f'},
  {id:'rainbow',name:'Rainbow',req:1e80,mult:1e5,color:'rainbow'},
  {id:'mono',name:'Monochrome',req:1e100,mult:1e6,color:'#888'},
];

// ===== GAME STATE =====
let G = makeDefaultState();
let activeTab = 'hz';
let automatorRunning = false;
let automatorInterval = null;

function makeDefaultState() {
  let s = {
    hz: ZERO, volume: ZERO, speakers: ZERO, infinity: ZERO, eternity: ZERO,
    volumeUnlocked: false, speakersUnlocked: false,
    infinityUnlocked: false, eternityUnlocked: false,
    infinityReq: D("1e308"), infinityTimes: ZERO,
    eternityReq: D("1e308"), eternityTimes: ZERO,
    machinesUnlocked: false, automatorUnlocked: false,
    infinityDialogShown: false, eternityDialogShown: false,
    achievements: {}, theme: 'black',
    automatorCode: '// Welcome to HzScript!\n// Type your automation code here\n\n',
    ups: {} // upgrade levels
  };
  // Init upgrade levels
  for (let type in UPGRADES) {
    UPGRADES[type].forEach(u => {
      s.ups[type + '_' + u.id] = ZERO;
    });
  }
  return s;
}

function getUpLevel(type, id) { return G.ups[type + '_' + id] || ZERO; }
function setUpLevel(type, id, v) { G.ups[type + '_' + id] = D(v); }
function getUpCost(type, id) {
  const u = UPGRADES[type].find(x => x.id === id);
  const lv = getUpLevel(type, id);
  return D(u.base).times(Decimal.pow(u.mult, lv));
}

// ===== UTILITY =====
function softcap(v, start, pow) {
  v = D(v); start = D(start);
  if (v.lte(start)) return v;
  return v.div(start).pow(pow).times(start);
}

function fmt(num, dec=2) {
  num = D(num);
  if (num.lt(0)) return '-' + fmt(num.neg(), dec);
  if (num.lt(1000)) return num.toFixed(num.lt(10) ? dec : 0);
  if (num.lt(1e6)) return num.toFixed(dec);
  if (num.lt(1e9)) {
    const a = ['','K','M','B'];
    const e = Math.floor(num.e / 3);
    return num.div(Decimal.pow(10, e*3)).toFixed(dec) + a[e];
  }
  if (num.layer > 0 || num.e >= 1000) {
    // XeYeZ
    if (num.e >= 1e6) {
      return num.mantissa.toFixed(2) + 'e' + fmt(D(num.e));
    }
    if (num.e >= 1000) {
      const e = num.e;
      const ie = Math.floor(Math.log10(e));
      const im = e / Math.pow(10, ie);
      return num.mantissa.toFixed(2) + 'e' + im.toFixed(2) + 'e' + ie;
    }
  }
  return num.mantissa.toFixed(2) + 'e' + num.e;
}

// ===== NERF MULTIPLIERS =====
function volNerf() {
  let m = ONE;
  if (G.volume.gte(1e3)) m = m.times(0.5);
  if (G.volume.gte(1e4)) m = m.times(0.25);
  if (G.volume.gte(1e5)) m = m.times(0.1);
  if (G.volume.gte(1e6)) m = m.times(0.05);
  if (G.volume.gte(1e7)) m = m.times(0.01);
  return m;
}
function spkNerf() {
  let m = ONE;
  if (G.speakers.gte(100)) m = m.times(0.5);
  if (G.speakers.gte(500)) m = m.times(0.3);
  if (G.speakers.gte(2e3)) m = m.times(0.15);
  if (G.speakers.gte(1e4)) m = m.times(0.05);
  if (G.speakers.gte(5e4)) m = m.times(0.01);
  return m;
}

// ===== MACHINE BOOST =====
function machineBoost() {
  if (!G.machinesUnlocked) return ONE;
  let b = ONE;
  MACHINES.forEach(m => {
    if (G.infinity.gte(m.req)) {
      b = b.times(Decimal.pow(m.mult, G.infinity.div(m.req).log10().plus(1)));
    }
  });
  return b;
}

// ===== ETERNITY BOOST =====
function eternityBoost() {
  if (!G.eternityUnlocked) return ONE;
  let b = G.eternity.plus(1).pow(10);
  const el = (id) => getUpLevel('eternity', id);
  if (el(1).gt(0)) b = b.times(Decimal.pow(10, el(1)));
  if (el(3).gt(0)) b = b.times(G.eternity.plus(1).pow(el(3).times(5)));
  if (el(5).gt(0)) b = b.times(G.eternity.plus(1).pow(el(5)));
  if (el(8).gt(0)) b = b.times(Decimal.pow(1e10, el(8)));
  if (el(13).gt(0)) b = b.times(Decimal.pow("1e50", el(13)));
  if (el(14).gt(0)) b = b.times(Decimal.pow("1e100", el(14)));
  if (el(17).gt(0)) b = b.times(Decimal.pow("1e200", el(17)));
  if (el(19).gt(0)) b = b.times(Decimal.pow("1e500", el(19)));
  return b;
}

// ===== HZ PER SEC =====
function calcHzPerSec() {
  let b = ONE;
  const hl = (id) => getUpLevel('hz', id);
  b = b.times(Decimal.pow(2, softcap(hl(1), 100, 0.5)));
  b = b.times(Decimal.pow(1.25, softcap(hl(2), 80, 0.6)));
  b = b.times(Decimal.pow(1.5, softcap(hl(3), 60, 0.55)));
  b = b.times(Decimal.pow(2, softcap(hl(4), 50, 0.5)));
  b = b.times(Decimal.pow(3, softcap(hl(5), 40, 0.45)));
  b = b.times(Decimal.pow(5, softcap(hl(6), 30, 0.4)));

  if (G.volumeUnlocked) {
    const vl = (id) => getUpLevel('volume', id);
    let vb = G.volume.plus(1).pow(0.8);
    if (vl(1).gt(0)) vb = vb.times(Decimal.pow(1.5, softcap(vl(1), 20, 0.5)));
    if (vl(3).gt(0)) b = b.times(Decimal.pow(2, softcap(vl(3), 15, 0.5)));
    if (vl(5).gt(0)) b = b.times(G.hz.plus(1).log10().plus(1).pow(vl(5).times(0.05)));
    b = b.times(vb);
  }

  if (G.speakersUnlocked) {
    const sl = (id) => getUpLevel('speaker', id);
    let sb = G.speakers.plus(1).pow(1.5);
    if (sl(1).gt(0)) sb = sb.times(Decimal.pow(2, softcap(sl(1), 10, 0.5)));
    if (sl(3).gt(0)) b = b.times(Decimal.pow(3, softcap(sl(3), 8, 0.5)));
    if (sl(5).gt(0)) b = b.times(G.volume.plus(1).pow(sl(5).times(0.3)));
    if (sl(7).gt(0)) b = b.times(Decimal.pow(10, softcap(sl(7), 5, 0.4)));
    b = b.times(sb);
  }

  if (G.infinityUnlocked) {
    const il = (id) => getUpLevel('infinity', id);
    let ib = G.infinity.plus(1).pow(3);
    if (il(1).gt(0)) b = b.times(Decimal.pow(10, il(1)));
    if (il(3).gt(0)) b = b.times(G.infinity.plus(1).pow(il(3).times(0.5)));
    if (il(5).gt(0)) b = b.times(Decimal.pow(2, il(5).times(G.speakers.plus(1).log10())));
    if (il(7).gt(0)) b = b.times(G.hz.plus(10).log10().pow(il(7).times(0.5)));
    if (il(9).gt(0)) b = b.times(Decimal.pow(100, il(9)));
    if (il(11).gt(0)) b = b.times(G.volume.plus(1).times(G.speakers.plus(1)).pow(il(11).times(0.2)));
    if (il(13).gt(0)) b = b.times(Decimal.pow(1000, il(13)));
    b = b.times(ib);
  }

  b = b.times(machineBoost());
  b = b.times(eternityBoost());

  if (b.gte("1e100")) b = softcap(b, D("1e100"), 0.75);
  return b;
}

// ===== PRESTIGE GAINS =====
function calcVolGain() {
  let b = G.hz.div(1e6).pow(0.4).floor();
  const vl = (id) => getUpLevel('volume', id);
  const sl = (id) => getUpLevel('speaker', id);
  const il = (id) => getUpLevel('infinity', id);
  const el = (id) => getUpLevel('eternity', id);
  if (vl(2).gt(0)) b = b.times(Decimal.pow(2, softcap(vl(2), 10, 0.5)));
  if (sl(2).gt(0)) b = b.times(Decimal.pow(1.5, softcap(sl(2), 8, 0.5)));
  if (sl(4).gt(0)) b = b.times(G.speakers.plus(1).pow(sl(4).times(0.5)));
  if (il(2).gt(0)) b = b.times(Decimal.pow(5, il(2)));
  if (il(6).gt(0)) b = b.times(G.infinity.plus(1).pow(il(6)));
  if (il(10).gt(0)) b = b.times(Decimal.pow(50, il(10)));
  if (el(4).gt(0)) b = b.times(Decimal.pow(1000, el(4)));
  b = b.times(machineBoost()).times(eternityBoost()).times(volNerf());
  return b.floor();
}

function calcSpkGain() {
  let b = G.volume.div(100).pow(0.35).floor();
  const sl = (id) => getUpLevel('speaker', id);
  const il = (id) => getUpLevel('infinity', id);
  const el = (id) => getUpLevel('eternity', id);
  if (sl(6).gt(0)) b = b.times(Decimal.pow(2, softcap(sl(6), 6, 0.5)));
  if (il(4).gt(0)) b = b.times(Decimal.pow(10, il(4)));
  if (il(8).gt(0)) b = b.times(G.infinity.plus(1).pow(il(8).times(0.75)));
  if (il(12).gt(0)) b = b.times(Decimal.pow(25, il(12)));
  if (el(4).gt(0)) b = b.times(Decimal.pow(1000, el(4)));
  b = b.times(machineBoost()).times(eternityBoost()).times(spkNerf());
  return b.floor();
}

function calcInfGain() {
  if (G.hz.lt(G.infinityReq)) return ZERO;
  let b = G.hz.log10().div(G.infinityReq.log10()).pow(0.5).floor();
  const il = (id) => getUpLevel('infinity', id);
  const el = (id) => getUpLevel('eternity', id);
  if (il(14).gt(0)) b = b.times(Decimal.pow(2, il(14)));
  if (el(2).gt(0)) b = b.times(Decimal.pow(100, el(2)));
  b = b.times(machineBoost()).times(eternityBoost());
  return b.floor().max(1);
}

function calcEtGain() {
  if (G.infinity.lt(G.eternityReq)) return ZERO;
  let b = G.infinity.log10().div(G.eternityReq.log10()).pow(0.4).floor();
  const el = (id) => getUpLevel('eternity', id);
  if (el(10).gt(0)) b = b.times(machineBoost().log10().plus(1));
  if (el(18).gt(0)) b = b.times(G.eternity.plus(1).pow(el(18)));
  return b.floor().max(1);
}

// ===== BUY UPGRADES =====
function getCurrency(type) {
  if (type==='hz') return G.hz;
  if (type==='volume') return G.volume;
  if (type==='speaker') return G.speakers;
  if (type==='infinity') return G.infinity;
  if (type==='eternity') return G.eternity;
}
function setCurrency(type, v) {
  if (type==='hz') G.hz = v;
  if (type==='volume') G.volume = v;
  if (type==='speaker') G.speakers = v;
  if (type==='infinity') G.infinity = v;
  if (type==='eternity') G.eternity = v;
}

function buyUp(type, id) {
  const cost = getUpCost(type, id);
  const cur = getCurrency(type);
  if (cur.gte(cost)) {
    setCurrency(type, cur.minus(cost));
    setUpLevel(type, id, getUpLevel(type, id).plus(1));
  }
}

function buyMaxUp(type, id) {
  let bought = 0;
  while (getCurrency(type).gte(getUpCost(type, id)) && bought < 100000) {
    buyUp(type, id);
    bought++;
  }
}

// ===== PRESTIGE =====
function resetHz() {
  G.hz = ZERO;
  UPGRADES.hz.forEach(u => setUpLevel('hz', u.id, ZERO));
}
function resetVol() {
  G.volume = ZERO;
  UPGRADES.volume.forEach(u => setUpLevel('volume', u.id, ZERO));
  resetHz();
}
function resetSpk() {
  G.speakers = ZERO; // don't reset speakers count
  UPGRADES.speaker.forEach(u => setUpLevel('speaker', u.id, ZERO));
  resetVol();
}
function resetInf() {
  UPGRADES.infinity.forEach(u => setUpLevel('infinity', u.id, ZERO));
  G.infinityReq = D("1e308");
  G.infinityTimes = ZERO;
  resetSpk();
  G.speakers = ZERO;
}
function resetEt() {
  UPGRADES.eternity.forEach(u => setUpLevel('eternity', u.id, ZERO));
  G.eternityReq = D("1e308");
  G.eternityTimes = ZERO;
  G.infinity = ZERO;
  resetInf();
}

function prestigeVolume() {
  const g = calcVolGain();
  if (g.gte(1) || (!G.volumeUnlocked && G.hz.gte(1e6))) {
    G.volume = G.volume.plus(g);
    G.volumeUnlocked = true;
    resetHz();
    showPopup(`+${fmt(g)} Volume`,'achievement');
  }
}
function prestigeSpeaker() {
  const g = calcSpkGain();
  if (g.gte(1) || (!G.speakersUnlocked && G.volume.gte(100))) {
    G.speakers = G.speakers.plus(g);
    G.speakersUnlocked = true;
    resetVol();
    showPopup(`+${fmt(g)} Speakers`,'achievement');
  }
}
function doInfinity() {
  const g = calcInfGain();
  if (g.lt(1) && G.infinityUnlocked) return;
  G.infinity = G.infinity.plus(g.max(1));
  G.infinityUnlocked = true;
  G.infinityTimes = G.infinityTimes.plus(1);
  G.infinityReq = G.infinityReq.times(Decimal.pow(10, Decimal.pow(2, G.infinityTimes)));
  resetSpk(); G.speakers = ZERO;
  showPopup(`+${fmt(g.max(1))} Infinity`,'achievement');
}
function bulkInfinity() {
  let total = ZERO, count = 0;
  while (G.hz.gte(G.infinityReq) && count < 10000) {
    const g = calcInfGain();
    total = total.plus(g);
    G.infinityTimes = G.infinityTimes.plus(1);
    G.infinityReq = G.infinityReq.times(Decimal.pow(10, Decimal.pow(2, G.infinityTimes)));
    count++;
  }
  if (total.gt(0)) {
    G.infinity = G.infinity.plus(total);
    resetSpk(); G.speakers = ZERO;
    showPopup(`Bulk +${fmt(total)} Infinity (${count}×)`,'achievement');
  }
}
function doEternity() {
  const g = calcEtGain();
  if (g.lt(1) && G.eternityUnlocked) return;
  G.eternity = G.eternity.plus(g.max(1));
  G.eternityUnlocked = true;
  G.eternityTimes = G.eternityTimes.plus(1);
  G.eternityReq = G.eternityReq.times(Decimal.pow(10, Decimal.pow(3, G.eternityTimes)));
  G.infinity = ZERO; resetInf();
  showPopup(`+${fmt(g.max(1))} Eternity`,'achievement');
}
function bulkEternity() {
  let total = ZERO, count = 0;
  while (G.infinity.gte(G.eternityReq) && count < 10000) {
    const g = calcEtGain();
    total = total.plus(g);
    G.eternityTimes = G.eternityTimes.plus(1);
    G.eternityReq = G.eternityReq.times(Decimal.pow(10, Decimal.pow(3, G.eternityTimes)));
    count++;
  }
  if (total.gt(0)) {
    G.eternity = G.eternity.plus(total);
    G.infinity = ZERO; resetInf();
    showPopup(`Bulk +${fmt(total)} Eternity (${count}×)`,'achievement');
  }
}

// ===== DIALOGUES =====
function typeWriter(el, text, speed, cb) {
  let i = 0; el.textContent = '';
  function type() {
    if (i < text.length) { el.textContent += text.charAt(i); i++; setTimeout(type, speed); }
    else if (cb) cb();
  }
  type();
}

function triggerInfinityDialog() {
  if (G.infinityDialogShown) return;
  G.infinityDialogShown = true;
  const p = document.getElementById('popup-infinity');
  const t = document.getElementById('typing-text');
  const b = document.getElementById('infinity-ok-btn');
  b.classList.add('hidden');
  p.classList.add('visible');
  typeWriter(t, "The Reality has collapsed due to so much hertz being made, the infinite being named 'Nal' has reset you for faster progression.", 1000/12, () => b.classList.remove('hidden'));
}
function acceptInfinity() {
  doInfinity();
  document.getElementById('popup-infinity').classList.remove('visible');
}

function triggerEternityDialog() {
  if (G.eternityDialogShown) return;
  G.eternityDialogShown = true;
  const p = document.getElementById('popup-eternity');
  const t = document.getElementById('typing-text-et');
  const b = document.getElementById('eternity-ok-btn');
  b.classList.add('hidden');
  p.classList.add('visible');
  const g = calcEtGain();
  typeWriter(t, `Due to so much infinities being made, The Infinities collapsed into ${fmt(g.max(1))} Eternities. You can have extreme upgrades to boost your progression even more.`, 1000/12, () => b.classList.remove('hidden'));
}
function acceptEternity() {
  doEternity();
  document.getElementById('popup-eternity').classList.remove('visible');
}

// ===== POPUP =====
function showPopup(msg, type='info') {
  const p = document.getElementById('popup');
  p.textContent = msg;
  p.classList.add('visible');
  p.style.background = type==='achievement' ? 'linear-gradient(135deg,#10b981,#34d399)' : 'rgba(0,0,0,0.9)';
  p.style.color = type==='achievement' ? '#000' : '#fff';
  setTimeout(() => p.classList.remove('visible'), 3000);
}

// ===== AUTOMATOR =====
let autoConsole = [];

function autoLog(msg, type='info') {
  autoConsole.push({msg, type, time: Date.now()});
  if (autoConsole.length > 200) autoConsole.shift();
}

function parseAutoLine(line) {
  line = line.trim();
  if (!line || line.startsWith('//')) return null;

  const tokens = line.split(/\s+/);
  const cmd = tokens[0].toLowerCase();

  if (cmd === 'buy' && tokens.length >= 3) return {type:'buy', layer:tokens[1], id:parseInt(tokens[2])};
  if (cmd === 'buymax' && tokens.length >= 3) return {type:'buymax', layer:tokens[1], id:parseInt(tokens[2])};
  if (cmd === 'prestige' && tokens.length >= 2) return {type:'prestige', layer:tokens[1]};
  if (cmd === 'infinity') return {type:'prestige', layer:'infinity'};
  if (cmd === 'eternity') return {type:'prestige', layer:'eternity'};
  if (cmd === 'bulkinf' || cmd === 'bulkinfinity') return {type:'bulkinf'};
  if (cmd === 'bulket' || cmd === 'bulketernity') return {type:'bulket'};
  if (cmd === 'wait' && tokens.length >= 2) return {type:'wait', ms:parseInt(tokens[1])};
  if (cmd === 'print') return {type:'print', msg:tokens.slice(1).join(' ')};
  if (cmd === 'stop') return {type:'stop'};
  
  // if resource > value then command
  if (cmd === 'if' && tokens.length >= 5) {
    const res = tokens[1];
    const op = tokens[2];
    const val = tokens[3];
    // "then" at index 4
    if (tokens[4].toLowerCase() === 'then') {
      const subLine = tokens.slice(5).join(' ');
      return {type:'if', resource:res, op:op, value:val, sub:subLine};
    }
  }

  // while resource > value do command
  if (cmd === 'while' && tokens.length >= 5) {
    const res = tokens[1];
    const op = tokens[2];
    const val = tokens[3];
    if (tokens[4].toLowerCase() === 'do') {
      const subLine = tokens.slice(5).join(' ');
      return {type:'while', resource:res, op:op, value:val, sub:subLine};
    }
  }

  // loop N do command
  if (cmd === 'loop' && tokens.length >= 4) {
    const count = parseInt(tokens[1]);
    if (tokens[2].toLowerCase() === 'do') {
      const subLine = tokens.slice(3).join(' ');
      return {type:'loop', count:count, sub:subLine};
    }
  }

  return {type:'unknown', line:line};
}

function getResource(name) {
  name = name.toLowerCase();
  if (name === 'hz') return G.hz;
  if (name === 'volume' || name === 'vol') return G.volume;
  if (name === 'speakers' || name === 'spk') return G.speakers;
  if (name === 'infinity' || name === 'inf') return G.infinity;
  if (name === 'eternity' || name === 'et') return G.eternity;
  if (name === 'hzpersec' || name === 'hzps') return calcHzPerSec();
  return ZERO;
}

function evalCondition(res, op, val) {
  const r = getResource(res);
  const v = D(val);
  if (op === '>') return r.gt(v);
  if (op === '<') return r.lt(v);
  if (op === '>=' || op === '=>') return r.gte(v);
  if (op === '<=' || op === '=<') return r.lte(v);
  if (op === '==' || op === '=') return r.eq(v);
  if (op === '!=') return !r.eq(v);
  return false;
}

function execCommand(parsed) {
  if (!parsed) return true;
  if (parsed.type === 'unknown') { autoLog(`Unknown: ${parsed.line}`, 'error'); return true; }
  if (parsed.type === 'buy') { buyUp(parsed.layer, parsed.id); autoLog(`Bought ${parsed.layer} #${parsed.id}`, 'success'); return true; }
  if (parsed.type === 'buymax') { buyMaxUp(parsed.layer, parsed.id); autoLog(`BuyMax ${parsed.layer} #${parsed.id}`, 'success'); return true; }
  if (parsed.type === 'prestige') {
    if (parsed.layer === 'volume' || parsed.layer === 'vol') prestigeVolume();
    else if (parsed.layer === 'speaker' || parsed.layer === 'spk' || parsed.layer === 'speakers') prestigeSpeaker();
    else if (parsed.layer === 'infinity' || parsed.layer === 'inf') doInfinity();
    else if (parsed.layer === 'eternity' || parsed.layer === 'et') doEternity();
    autoLog(`Prestige: ${parsed.layer}`, 'success');
    return true;
  }
  if (parsed.type === 'bulkinf') { bulkInfinity(); autoLog('Bulk Infinity', 'success'); return true; }
  if (parsed.type === 'bulket') { bulkEternity(); autoLog('Bulk Eternity', 'success'); return true; }
  if (parsed.type === 'print') { autoLog(parsed.msg, 'info'); return true; }
  if (parsed.type === 'stop') { stopAutomator(); return false; }
  if (parsed.type === 'if') {
    if (evalCondition(parsed.resource, parsed.op, parsed.value)) {
      const sub = parseAutoLine(parsed.sub);
      return execCommand(sub);
    }
    return true;
  }
  if (parsed.type === 'loop') {
    for (let i = 0; i < Math.min(parsed.count, 10000); i++) {
      const sub = parseAutoLine(parsed.sub);
      if (!execCommand(sub)) return false;
    }
    return true;
  }
  if (parsed.type === 'while') {
    let iter = 0;
    while (evalCondition(parsed.resource, parsed.op, parsed.value) && iter < 10000) {
      const sub = parseAutoLine(parsed.sub);
      if (!execCommand(sub)) return false;
      iter++;
    }
    return true;
  }
  if (parsed.type === 'wait') return true; // handled by interval
  return true;
}

let autoLines = [];
let autoPC = 0;
let autoWaitUntil = 0;

function startAutomator() {
  const editor = document.getElementById('auto-editor');
  if (!editor) return;
  G.automatorCode = editor.value;
  autoLines = G.automatorCode.split('\n');
  autoPC = 0;
  autoWaitUntil = 0;
  automatorRunning = true;
  autoConsole = [];
  autoLog('Automator started', 'success');
}

function stopAutomator() {
  automatorRunning = false;
  autoLog('Automator stopped', 'warn');
}

function tickAutomator() {
  if (!automatorRunning || autoPC >= autoLines.length) {
    if (automatorRunning && autoPC >= autoLines.length) {
      autoPC = 0; // loop back
    }
    return;
  }
  
  if (Date.now() < autoWaitUntil) return;
  
  const line = autoLines[autoPC];
  const parsed = parseAutoLine(line);
  
  if (parsed && parsed.type === 'wait') {
    autoWaitUntil = Date.now() + parsed.ms;
    autoPC++;
    return;
  }
  
  if (parsed) {
    const cont = execCommand(parsed);
    if (!cont) return;
  }
  
  autoPC++;
}

// ===== SAVE/LOAD =====
function saveGame() {
  const s = {};
  for (let key in G) {
    if (G[key] instanceof Decimal) s[key] = G[key].toString();
    else if (typeof G[key] === 'object' && !(G[key] instanceof Decimal)) {
      s[key] = {};
      for (let k2 in G[key]) {
        if (G[key][k2] instanceof Decimal) s[key][k2] = G[key][k2].toString();
        else s[key][k2] = G[key][k2];
      }
    }
    else s[key] = G[key];
  }
  localStorage.setItem('hzSave', JSON.stringify(s));
}

function loadSaveData(data) {
  try {
    const p = typeof data === 'string' ? JSON.parse(data) : data;
    G = makeDefaultState();
    for (let key in p) {
      if (key === 'achievements' || key === 'ups') {
        for (let k2 in p[key]) {
          if (typeof p[key][k2] === 'string' && !isNaN(p[key][k2])) G[key][k2] = D(p[key][k2]);
          else G[key][k2] = p[key][k2];
        }
      } else if (key === 'theme' || key === 'automatorCode' ||
                 key === 'infinityDialogShown' || key === 'eternityDialogShown' ||
                 key === 'volumeUnlocked' || key === 'speakersUnlocked' ||
                 key === 'infinityUnlocked' || key === 'eternityUnlocked' ||
                 key === 'machinesUnlocked' || key === 'automatorUnlocked') {
        G[key] = p[key];
      } else if (typeof p[key] === 'string') {
        G[key] = D(p[key]);
      }
    }
    applyTheme(G.theme);
  } catch(e) { console.error('Load failed:', e); }
}

function loadGameFromInput() {
  loadSaveData(document.getElementById('save-input').value);
  document.getElementById('popup2').classList.remove('visible');
  showPopup('Game Loaded!');
}

function exportSave() {
  saveGame();
  navigator.clipboard.writeText(localStorage.getItem('hzSave'));
  showPopup('Save copied!');
}

function downloadSave() {
  saveGame();
  const blob = new Blob([localStorage.getItem('hzSave')], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'hertz_save.json';
  a.click();
  showPopup('Save downloaded!');
}

function hardReset() {
  if (confirm('Delete ALL progress?')) {
    localStorage.removeItem('hzSave');
    location.reload();
  }
}

function applyTheme(theme) {
  THEMES.forEach(t => document.body.classList.remove('theme-' + t));
  document.body.classList.add('theme-' + theme);
  document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
  const tb = document.getElementById('theme-' + theme);
  if (tb) tb.classList.add('active');
}

// ===== RENDER =====
function renderSidebar() {
  const el = document.getElementById('sidebar-tabs');
  el.innerHTML = '';
  TABS.forEach(tab => {
    if (tab.hidden && tab.hidden()) return;
    const isActive = activeTab === tab.id;
    const sz = tab.size || 'text-lg';
    el.innerHTML += `<div id="tab-${tab.id}" class="tab ${sz} ${isActive ? tab.color + ' text-black' : 'text-gray-300 bg-gray-800'} p-3 cursor-pointer rounded-lg border-2 ${tab.border}" onclick="switchTab('${tab.id}')"><i class="fas fa-${tab.icon}"></i> ${tab.name}</div>`;
  });
}

function switchTab(name) {
  activeTab = name;
  render();
}

function renderUpgradeGrid(type, currency) {
  return UPGRADES[type].map(u => {
    const lv = getUpLevel(type, u.id);
    const cost = getUpCost(type, u.id);
    const can = currency.gte(cost);
    return `<div class="upgrade-card border-${u.color}-400">
      <div class="text-xl font-bold mb-1 text-primary"><i class="fas fa-${u.icon}"></i> ${u.name}</div>
      <div class="text-sm mb-2 text-secondary">${u.desc}</div>
      <div class="flex justify-between items-center">
        <div>
          <div class="text-sm text-secondary">Cost: <span class="text-${u.color}-400">${fmt(cost)}</span></div>
          <div class="text-xs text-secondary">Lv: ${fmt(lv)}</div>
        </div>
        <div class="flex space-x-2">
          <button class="upgrade-btn border-${u.color}-400 text-${u.color}-400" onclick="buyUp('${type}',${u.id})" ${!can?'disabled':''}>BUY</button>
          <button class="upgrade-btn border-${u.color}-400 text-${u.color}-400" onclick="buyMaxUp('${type}',${u.id})" ${!can?'disabled':''}>MAX</button>
        </div>
      </div>
    </div>`;
  }).join('');
}

function renderContent() {
  const el = document.getElementById('main-content');
  let html = '';

  if (activeTab === 'hz') {
    const hps = calcHzPerSec();
    html = `<div class="stat-display text-center">
      <div class="text-2xl mb-1 text-secondary">You Have</div>
      <div class="text-6xl font-bold mb-3 text-primary">${fmt(G.hz)} Hz</div>
      <div class="text-xl text-secondary">${fmt(hps)} Hz/s</div>
    </div>
    <div class="grid-upgrades">${renderUpgradeGrid('hz', G.hz)}</div>
    <div class="stat-display mt-6 bg-purple-900 bg-opacity-30 border-purple-500">
      <div class="text-2xl font-bold mb-3 text-purple-400"><i class="fas fa-volume-up"></i> VOLUME PRESTIGE</div>
      <div class="text-lg mb-3 text-secondary">Gain <span class="text-purple-300 font-bold">${fmt(calcVolGain())}</span> Volume</div>
      <button class="prestige-btn bg-gradient-to-r from-purple-500 to-indigo-500 border-purple-400" onclick="prestigeVolume()" ${calcVolGain().lt(1)&&!(!G.volumeUnlocked&&G.hz.gte(1e6))?'disabled':''}>VOLUME UP</button>
    </div>`;
  }

  else if (activeTab === 'volume') {
    const vb = G.volume.plus(1).pow(0.8);
    html = `<div class="stat-display text-center">
      <div class="text-2xl mb-1 text-secondary"><i class="fas fa-volume-up"></i> Volume</div>
      <div class="text-6xl font-bold mb-3 text-purple-400">${fmt(G.volume)}</div>
      <div class="text-xl text-secondary">Hz Boost: <span class="text-purple-300">${fmt(vb)}x</span></div>
      ${volNerf().lt(1)?`<div class="nerf-indicator">⚠ NERF: ${fmt(volNerf().times(100))}%</div>`:''}
    </div>
    <div class="grid-upgrades">${renderUpgradeGrid('volume', G.volume)}</div>
    ${G.volumeUnlocked?`<div class="stat-display mt-6 bg-teal-900 bg-opacity-30 border-teal-500">
      <div class="text-2xl font-bold mb-3 text-teal-400"><i class="fas fa-broadcast-tower"></i> SPEAKER PRESTIGE</div>
      <div class="text-lg mb-3 text-secondary">Gain <span class="text-teal-300 font-bold">${fmt(calcSpkGain())}</span> Speakers</div>
      <button class="prestige-btn bg-gradient-to-r from-teal-500 to-cyan-500 border-teal-400" onclick="prestigeSpeaker()" ${calcSpkGain().lt(1)&&!(!G.speakersUnlocked&&G.volume.gte(100))?'disabled':''}>SPEAKERS UP</button>
    </div>`:''}`;
  }

  else if (activeTab === 'speakers') {
    const sb = G.speakers.plus(1).pow(1.5);
    html = `<div class="stat-display text-center">
      <div class="text-2xl mb-1 text-secondary"><i class="fas fa-broadcast-tower"></i> Speakers</div>
      <div class="text-6xl font-bold mb-3 text-teal-400">${fmt(G.speakers)}</div>
      <div class="text-xl text-secondary">Boost: <span class="text-teal-300">${fmt(sb)}x</span></div>
      ${spkNerf().lt(1)?`<div class="nerf-indicator">⚠ NERF: ${fmt(spkNerf().times(100))}%</div>`:''}
    </div>
    <div class="grid-upgrades">${renderUpgradeGrid('speaker', G.speakers)}</div>
    ${G.infinityUnlocked?`<div class="stat-display mt-6 bg-pink-900 bg-opacity-30 border-pink-500">
      <div class="text-2xl font-bold mb-3 infinity-text"><i class="fas fa-infinity"></i> INFINITY PRESTIGE</div>
      <div class="text-lg mb-1 text-secondary">Times: <span class="infinity-text font-bold">${fmt(G.infinityTimes)}</span></div>
      <div class="text-lg mb-1 text-secondary">Gain: <span class="infinity-text font-bold">${fmt(calcInfGain())}</span> | Next: <span class="text-pink-300">${fmt(G.infinityReq)}</span> Hz</div>
      <div class="flex space-x-3 mt-3">
        <button class="prestige-btn flex-1 bg-gradient-to-r from-pink-500 to-purple-600 border-pink-400" onclick="doInfinity()" ${calcInfGain().lt(1)?'disabled':''}>INFINITIZE</button>
        <button class="prestige-btn flex-1 bg-gradient-to-r from-purple-500 to-pink-600 border-purple-400" onclick="bulkInfinity()" ${calcInfGain().lt(1)?'disabled':''}>BULK INF</button>
      </div>
    </div>`:''}`;
  }

  else if (activeTab === 'infinity') {
    const ib = G.infinity.plus(1).pow(3);
    html = `<div class="stat-display text-center">
      <div class="text-2xl mb-1 text-secondary"><i class="fas fa-infinity"></i> Infinity</div>
      <div class="text-6xl font-bold mb-3 infinity-text">${fmt(G.infinity)}</div>
      <div class="text-xl text-secondary">Boost: <span class="infinity-text">${fmt(ib)}x</span></div>
    </div>
    <div class="grid-upgrades">${renderUpgradeGrid('infinity', G.infinity)}</div>
    ${G.eternityUnlocked?`<div class="stat-display mt-6 bg-green-900 bg-opacity-30 border-green-500">
      <div class="text-2xl font-bold mb-3 eternity-text"><i class="fas fa-hourglass-half"></i> ETERNITY PRESTIGE</div>
      <div class="text-lg mb-1 text-secondary">Times: <span class="eternity-text font-bold">${fmt(G.eternityTimes)}</span></div>
      <div class="text-lg mb-1 text-secondary">Gain: <span class="eternity-text font-bold">${fmt(calcEtGain())}</span> | Next: <span class="text-green-300">${fmt(G.eternityReq)}</span> Inf</div>
      <div class="flex space-x-3 mt-3">
        <button class="prestige-btn flex-1 bg-gradient-to-r from-green-500 to-cyan-500 border-green-400" onclick="doEternity()" ${calcEtGain().lt(1)?'disabled':''}>ETERNITIZE</button>
        <button class="prestige-btn flex-1 bg-gradient-to-r from-cyan-500 to-green-500 border-cyan-400" onclick="bulkEternity()" ${calcEtGain().lt(1)?'disabled':''}>BULK ET</button>
      </div>
    </div>`:''}`;
  }

  else if (activeTab === 'eternity') {
    const eb = eternityBoost();
    html = `<div class="stat-display text-center">
      <div class="text-2xl mb-1 text-secondary"><i class="fas fa-hourglass-half"></i> Eternity</div>
      <div class="text-6xl font-bold mb-3 eternity-text">${fmt(G.eternity)}</div>
      <div class="text-xl text-secondary">All Boost: <span class="eternity-text">${fmt(eb)}x</span></div>
    </div>
    <div class="grid-upgrades">${renderUpgradeGrid('eternity', G.eternity)}</div>`;
  }

  else if (activeTab === 'machines') {
    html = `<div class="stat-display text-center">
      <div class="text-2xl mb-3 infinity-text"><i class="fas fa-cogs"></i> INFINITE MACHINES</div>
      <div class="text-lg text-secondary mb-4">Total Boost: ${fmt(machineBoost())}x</div>
    </div>
    <div class="grid grid-cols-2 gap-4">${MACHINES.map(m => {
      const unlocked = G.infinity.gte(m.req);
      const cls = unlocked ? '' : 'locked';
      const col = m.color === 'rainbow' ? '' : `color:${m.color}`;
      const textCls = m.color === 'rainbow' ? 'rainbow-text' : '';
      return `<div class="machine-card ${cls}" style="border-color:${m.color==='rainbow'?'#ec4899':m.color}">
        <div class="text-2xl mb-1 ${textCls}" style="${col}"><i class="fas fa-cog"></i></div>
        <div class="text-xl font-bold ${textCls}" style="${col}">${m.name} Machine</div>
        <div class="text-xs text-secondary mt-1">Req: ${fmt(D(m.req))} Inf</div>
        <div class="text-sm text-secondary mt-1">×${fmt(D(m.mult))} per log</div>
      </div>`;
    }).join('')}</div>`;
  }

  else if (activeTab === 'automator') {
    const code = G.automatorCode || '';
    const consoleHtml = autoConsole.slice(-50).map(l => `<div class="log-${l.type}">[${new Date(l.time).toLocaleTimeString()}] ${l.msg}</div>`).join('');
    html = `<div class="stat-display">
      <div class="text-2xl font-bold mb-4 text-primary"><i class="fas fa-code"></i> HzScript Automator</div>
      <div class="flex space-x-3 mb-4">
        <button class="upgrade-btn border-green-400 text-green-400" onclick="startAutomator()"><i class="fas fa-play"></i> RUN</button>
        <button class="upgrade-btn border-red-400 text-red-400" onclick="stopAutomator()"><i class="fas fa-stop"></i> STOP</button>
        <span class="text-sm text-secondary self-center ml-2">${automatorRunning?'<span class="text-green-400">● Running (Line '+(autoPC+1)+')</span>':'<span class="text-red-400">● Stopped</span>'}</span>
      </div>
      <textarea id="auto-editor" class="code-editor" spellcheck="false" oninput="G.automatorCode=this.value">${code.replace(/</g,'&lt;')}</textarea>
      <div class="text-lg font-bold mt-4 mb-2 text-primary">Console</div>
      <div class="console-output" id="auto-console">${consoleHtml}</div>
    </div>
    <div class="stat-display mt-4">
      <div class="text-xl font-bold mb-3 text-primary"><i class="fas fa-book"></i> HzScript Documentation</div>
      <div class="doc-section">
        <div class="text-lg font-bold mb-2">Commands</div>
        <p class="text-secondary mb-1"><code>buy &lt;layer&gt; &lt;id&gt;</code> — Buy one upgrade</p>
        <p class="text-secondary mb-1"><code>buymax &lt;layer&gt; &lt;id&gt;</code> — Buy max of upgrade</p>
        <p class="text-secondary mb-1"><code>prestige &lt;layer&gt;</code> — Prestige (volume/speaker/infinity/eternity)</p>
        <p class="text-secondary mb-1"><code>infinity</code> / <code>eternity</code> — Quick prestige</p>
        <p class="text-secondary mb-1"><code>bulkinf</code> / <code>bulket</code> — Bulk prestige</p>
        <p class="text-secondary mb-1"><code>wait &lt;ms&gt;</code> — Wait milliseconds</p>
        <p class="text-secondary mb-1"><code>print &lt;message&gt;</code> — Print to console</p>
        <p class="text-secondary mb-1"><code>stop</code> — Stop automator</p>
      </div>
      <div class="doc-section mt-3">
        <div class="text-lg font-bold mb-2">Control Flow</div>
        <p class="text-secondary mb-1"><code>if &lt;resource&gt; &lt;op&gt; &lt;value&gt; then &lt;command&gt;</code></p>
        <p class="text-secondary mb-1"><code>while &lt;resource&gt; &lt;op&gt; &lt;value&gt; do &lt;command&gt;</code></p>
        <p class="text-secondary mb-1"><code>loop &lt;count&gt; do &lt;command&gt;</code></p>
      </div>
      <div class="doc-section mt-3">
        <div class="text-lg font-bold mb-2">Resources</div>
        <p class="text-secondary mb-1"><code>hz</code>, <code>volume</code>/<code>vol</code>, <code>speakers</code>/<code>spk</code>, <code>infinity</code>/<code>inf</code>, <code>eternity</code>/<code>et</code>, <code>hzpersec</code>/<code>hzps</code></p>
      </div>
      <div class="doc-section mt-3">
        <div class="text-lg font-bold mb-2">Operators</div>
        <p class="text-secondary"><code>&gt;</code> <code>&lt;</code> <code>&gt;=</code> <code>&lt;=</code> <code>==</code> <code>!=</code></p>
      </div>
      <div class="doc-section mt-3">
        <div class="text-lg font-bold mb-2">Layers</div>
        <p class="text-secondary"><code>hz</code> (1-6), <code>volume</code> (1-6), <code>speaker</code> (1-7), <code>infinity</code> (1-15), <code>eternity</code> (1-20)</p>
      </div>
      <div class="doc-section mt-3">
        <div class="text-lg font-bold mb-2">Example</div>
        <pre class="text-secondary text-sm">// Auto prestige loop
buymax hz 1
buymax hz 2
wait 500
if hz > 1000000 then prestige volume
if vol > 100 then prestige speaker
wait 1000</pre>
      </div>
    </div>`;
  }

  else if (activeTab === 'achievements') {
    html = `<div class="stat-display">
      <div class="text-2xl font-bold mb-4 text-center text-primary"><i class="fas fa-trophy"></i> ACHIEVEMENTS (${ACHIEVEMENTS.filter(a=>G.achievements[a.id]).length}/${ACHIEVEMENTS.length})</div>
      ${ACHIEVEMENTS.map(a => `<div class="achievement ${G.achievements[a.id]?'completed':''}">
        <span>${a.name}</span><span class="text-sm">${a.desc}</span>
      </div>`).join('')}
    </div>`;
  }

  else if (activeTab === 'settings') {
    html = `<div class="stat-display">
      <div class="text-2xl font-bold mb-4 text-primary"><i class="fas fa-cog"></i> SETTINGS</div>
      <div class="space-y-3">
        <button onclick="saveGame();showPopup('Saved!')" class="upgrade-btn border-green-400 text-green-400 w-full"><i class="fas fa-save"></i> SAVE</button>
        <button onclick="document.getElementById('popup2').classList.add('visible')" class="upgrade-btn border-blue-400 text-blue-400 w-full"><i class="fas fa-upload"></i> LOAD</button>
        <button onclick="exportSave()" class="upgrade-btn border-yellow-400 text-yellow-400 w-full"><i class="fas fa-copy"></i> COPY SAVE</button>
        <button onclick="downloadSave()" class="upgrade-btn border-purple-400 text-purple-400 w-full"><i class="fas fa-download"></i> DOWNLOAD</button>
        <button onclick="document.getElementById('popup-theme').classList.add('visible')" class="upgrade-btn border-pink-400 text-pink-400 w-full"><i class="fas fa-palette"></i> THEME</button>
        <button onclick="hardReset()" class="upgrade-btn border-red-400 text-red-400 w-full"><i class="fas fa-trash"></i> HARD RESET</button>
      </div>
    </div>`;
  }

  else if (activeTab === 'changelog') {
    html = `<div class="stat-display">
      <div class="text-2xl font-bold mb-4 text-primary"><i class="fas fa-list"></i> CHANGELOG</div>
      <div class="upgrade-card border-blue-400 mb-3">
        <div class="text-xl font-bold mb-2 text-primary">v0.4.4a - The Automator Update 🤖</div>
        <ul class="list-disc list-inside space-y-1 text-secondary text-sm">
          <li>NEW: HzScript - Custom programming language for automation!</li>
          <li>Unlocked after Rainbow Machine</li>
          <li>Full text-based scripting with conditionals, loops, wait</li>
          <li>Console output and documentation</li>
          <li>Animated gradient backgrounds for all themes</li>
          <li>20+ achievements</li>
          <li>All code merged into single file</li>
          <li>Proper Break Eternity integration</li>
          <li>Buy Max with no limits everywhere</li>
          <li>XeYeZ notation with 2 decimal places</li>
        </ul>
      </div>
      <div class="upgrade-card border-green-400 mb-3">
        <div class="text-xl font-bold mb-2 text-primary">v0.4.3a - The Eternity Update</div>
        <ul class="list-disc list-inside text-secondary text-sm">
          <li>Eternity prestige layer with 20 Godlike upgrades</li>
          <li>Scrollable tabs and content</li>
        </ul>
      </div>
    </div>`;
  }

  else if (activeTab === 'about') {
    html = `<div class="stat-display text-center">
      <div class="text-3xl font-bold mb-6 text-yellow-400"><i class="fas fa-question-circle"></i> About This Game</div>
      <div class="text-lg text-secondary leading-relaxed mb-10 text-left">
        <p class="mb-3">This game started out as a blank page with text saying "it's coming soon."</p>
        <p class="mb-3">Then it showed regular buttons and a Hz meter (just orange).</p>
        <p class="mb-3">Then it changed to a blue theme with tabs until v0.3.2a.</p>
        <p class="mb-3">Then it was entirely CHANGED and had a new look.</p>
        <p class="mb-6">And now... it's now a cool game that you're playing now. The incredible journey I had.</p>
        <p class="text-center italic">This wouldn't be possible without You guys.</p>
      </div>
      <div class="text-5xl font-bold rainbow-text">Sincerely, Rubix.</div>
    </div>`;
  }

  el.innerHTML = html;
}

function render() {
  renderSidebar();
  renderContent();
}

// ===== THEME BUTTONS =====
function initThemeButtons() {
  const el = document.getElementById('theme-buttons');
  el.innerHTML = THEMES.map(t =>
    `<div id="theme-${t}" class="theme-btn ${G.theme===t?'active':''}" style="background:linear-gradient(135deg,${THEME_COLORS[t]})" onclick="G.theme='${t}';applyTheme('${t}');document.getElementById('popup-theme').classList.remove('visible')"></div>`
  ).join('');
}

// ===== ACHIEVEMENTS =====
function checkAchievements() {
  ACHIEVEMENTS.forEach(a => {
    if (!G.achievements[a.id] && a.check()) {
      G.achievements[a.id] = true;
      showPopup(`Achievement: ${a.name}!`, 'achievement');
    }
  });
}

// ===== PASSIVE GENERATION =====
function passiveTick() {
  const il = (id) => getUpLevel('infinity', id);
  const el = (id) => getUpLevel('eternity', id);
  
  if (il(15).gt(0) && G.infinityUnlocked) {
    let gain = il(15).times(0.01).div(30);
    if (el(12).gt(0)) gain = gain.times(Decimal.pow(1000, el(12)));
    G.infinity = G.infinity.plus(gain);
  }
  
  if (el(20).gt(0) && G.eternityUnlocked) {
    G.eternity = G.eternity.plus(el(20).times(0.001).div(30));
  }
}

// ===== GAME LOOP =====
function gameLoop() {
  G.hz = G.hz.plus(calcHzPerSec().div(30));
  passiveTick();
  
  // Check rainbow machine -> unlock automator
  if (G.infinity.gte(1e80) && !G.automatorUnlocked) {
    G.automatorUnlocked = true;
    showPopup('Automator Unlocked!', 'achievement');
  }
  
  // Machines unlock
  if (G.infinity.gte(1e6) && !G.machinesUnlocked) {
    G.machinesUnlocked = true;
  }
  
  // Triggers
  if (G.hz.gte(G.infinityReq) && !G.infinityUnlocked) triggerInfinityDialog();
  if (G.infinity.gte(G.eternityReq) && !G.eternityUnlocked) triggerEternityDialog();
  
  checkAchievements();
  tickAutomator();
  render();
}

// ===== INIT =====
const savedData = localStorage.getItem('hzSave');
if (savedData) loadSaveData(savedData);
applyTheme(G.theme);
initThemeButtons();
render();

setInterval(gameLoop, 1000 / 30);
setInterval(() => { saveGame(); }, 30000);
</script>
</body>
</html>
